# 测试指南

> AI 聊天机器人项目的完整测试指南
> **最后更新**：2026-01-16

---

## 📋 目录

- [测试概览](#测试概览)
- [环境准备](#环境准备)
- [手动测试流程](#手动测试流程)
- [功能测试清单](#功能测试清单)
- [API 接口测试](#api-接口测试)
- [流式响应测试](#流式响应测试)
- [Function Calling 测试](#function-calling-测试)
- [性能测试](#性能测试)
- [回归测试](#回归测试)

---

## 测试概览

### 测试类型

| 测试类型 | 目的 | 工具 | 频率 |
|---------|------|------|------|
| **手动测试** | 验证功能完整性 | 浏览器、curl | 每次代码变更 |
| **功能测试** | 验证需求实现 | 浏览器 | 每次代码变更 |
| **API 测试** | 验证接口正确性 | Postman、curl | 每个 API 变更 |
| **流式测试** | 验证 SSE 功能 | 浏览器 | 每次流式代码变更 |
| **回归测试** | 验证旧功能未破坏 | 测试清单 | 每次发布前 |

### 测试原则

1. **先测试核心功能** - AI 对话、流式响应
2. **逐步测试边缘情况** - 网络错误、超时、大消息
3. **记录测试结果** - 使用测试清单
4. **自动化重复测试** - 编写测试脚本（未来）

---

## 环境准备

### 1. 启动服务

```bash
# 确保服务已启动
npm start

# 确认服务正常运行
curl http://localhost:3000/api/health
```

### 2. 准备测试工具

**浏览器开发者工具**：
- 打开 Chrome DevTools（F12）
- 准备使用 Network、Console 面板

**API 测试工具**：
- Postman（可选）
- curl（命令行）
- HTTPie（命令行，可选）

**测试环境配置**：
```bash
# 确认 API Keys 已配置
echo $GLM_API_KEY
echo $DEEPSEEK_API_KEY
```

---

## 手动测试流程

### 基础流程测试

#### 测试1：服务启动

**步骤**：
1. 运行 `npm start`
2. 访问 `http://localhost:3000`
3. 检查页面是否正常加载
4. 检查浏览器控制台是否有错误

**预期结果**：
- ✅ 服务正常启动，无错误日志
- ✅ 页面正常显示
- ✅ 控制台无 JavaScript 错误

---

#### 测试2：基本对话功能

**步骤**：
1. 在输入框输入："你好"
2. 点击发送按钮
3. 等待 AI 回复

**预期结果**：
- ✅ 用户消息立即显示
- ✅ AI 回复正常显示（逐字或一次性）
- ✅ 对话历史保存到 localStorage

**检查点**：
```javascript
// 浏览器控制台
localStorage.getItem('conversationHistory');
// 应该包含对话历史
```

---

#### 测试3：流式响应

**步骤**：
1. 发送一条较长的问题（如"写一首诗"）
2. 观察回复是否逐字显示
3. 检查打字机效果

**预期结果**：
- ✅ 文本逐字显示（打字机效果）
- ✅ 无明显延迟或卡顿
- ✅ 最终回复完整

**检查点**：
```javascript
// 浏览器 Network 面板
// 查找 /api/chat/stream 请求
// 应该是 text/event-stream 类型
```

---

#### 测试4：切换虚拟形象

**步骤**：
1. 点击顶部虚拟形象下拉菜单
2. 选择不同的虚拟形象（如"咪咪"）
3. 观察界面变化

**预期结果**：
- ✅ 虚拟形象立即切换
- ✅ 背景渐变色改变
- ✅ 虚拟形象名称和表情更新

---

#### 测试5：切换 AI 模型

**步骤**：
1. 点击模型切换按钮
2. 选择另一个模型（如 DeepSeek）
3. 发送消息测试

**预期结果**：
- ✅ 模型切换成功
- ✅ 提示消息显示"已切换到 DeepSeek 模型"
- ✅ 后续消息使用新模型

---

### 快速开始功能测试

#### 测试6：快速开始按钮

**步骤**：
1. 点击任意快速开始按钮（3个）
2. 观察消息是否自动填充
3. 点击发送

**预期结果**：
- ✅ 消息自动填充到输入框
- ✅ 光标定位到输入框
- ✅ 可以正常发送

---

## 功能测试清单

### 核心功能

#### 对话功能

- [ ] 发送消息（短消息 < 100字）
- [ ] 发送消息（长消息 > 500字）
- [ ] 发送超长消息（接近10000字限制）
- [ ] 发送空消息（应该被拒绝）
- [ ] 发送特殊字符（emoji、代码片段）
- [ ] 多轮对话（上下文记忆）
- [ ] 清空对话历史

#### 流式响应

- [ ] 流式响应正常工作
- [ ] 流式中断后能正确处理
- [ ] 流式响应超时处理
- [ ] 多次快速发送消息
- [ ] 取消正在发送的消息

#### 虚拟形象

- [ ] 切换到"小樱"
- [ ] 切换到"咪咪"
- [ ] 切换到"小智"
- [ ] 切换到"阿狐"
- [ ] 刷新页面后保持选择

#### AI 模型

- [ ] 切换到 GLM-4
- [ ] 切换到 DeepSeek
- [ ] API Key 未配置时的错误提示

---

### Function Calling 功能

#### 工具调用

- [ ] 文章总结工具
  - 测试消息："请总结这篇文章的主要内容：[粘贴长文本]"

- [ ] 关键信息提取工具
  - 测试消息："从这段文本中提取关键信息：[粘贴文本]"

- [ ] 天气查询工具
  - 测试消息："查询北京今天的天气"
  - 测试消息："What's the weather in London?"

- [ ] 工具调用失败处理
  - 模拟工具执行失败

#### 工具标识

- [ ] 工具调用时显示"🔧 已使用工具"
- [ ] 显示工具名称
- [ ] 显示工具参数（简化版）

---

### 错误处理

#### 网络错误

- [ ] 断网情况下发送消息
- [ ] 服务器无响应
- [ ] API 超时

#### 输入验证

- [ ] 发送空消息
- [ ] 发送超长消息（>10000字）
- [ ] 发送非文本内容

#### API 错误

- [ ] API Key 错误
- [ ] API 配额用尽
- [ ] AI 服务不可用

---

### 用户界面

#### 响应式设计

- [ ] 桌面端（>1200px）
- [ ] 平板端（768px - 1200px）
- [ ] 移动端（<768px）

#### 交互体验

- [ ] 自动滚动到底部
- [ ] 输入框自动聚焦
- [ ] 消息气泡样式正确
- [ ] 加载状态指示

#### 数据持久化

- [ ] 对话历史保存
- [ ] 刷新页面后历史恢复
- [ ] 虚拟形象选择保存
- [ ] 模型选择保存

---

## API 接口测试

### 使用 curl 测试

#### 1. 健康检查

```bash
curl http://localhost:3000/api/health
```

**预期响应**：
```json
{
  "status": "ok",
  "timestamp": "2026-01-16T10:30:00.000Z",
  "models": {
    "glm": true,
    "deepseek": true
  }
}
```

---

#### 2. 获取模型列表

```bash
curl http://localhost:3000/api/models
```

**预期响应**：
```json
{
  "models": [
    {
      "id": "glm",
      "name": "GLM-4 (智谱AI)",
      "provider": "glm"
    }
  ],
  "default": "glm"
}
```

---

#### 3. 非流式聊天

```bash
curl -X POST http://localhost:3000/api/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "你好",
    "provider": "glm"
  }'
```

**预期响应**：
```json
{
  "reply": "你好！我是AI助手...",
  "model": "glm-4",
  "usage": {
    "prompt_tokens": 10,
    "completion_tokens": 20,
    "total_tokens": 30
  },
  "provider": "glm"
}
```

---

#### 4. 流式聊天

```bash
curl -X POST http://localhost:3000/api/chat/stream \
  -H "Content-Type: application/json" \
  -d '{
    "message": "写一首短诗",
    "provider": "glm"
  }'
```

**预期响应**：
```
data: {"type":"start","message":"开始生成..."}
data: {"type":"token","content":"春"}
data: {"type":"token","content":"天"}
data: {"type":"token","content":"来"}
...
data: {"type":"end","usage":{...}}
```

---

#### 5. 切换模型

```bash
curl -X POST http://localhost:3000/api/set-model \
  -H "Content-Type: application/json" \
  -d '{
    "provider": "deepseek"
  }'
```

**预期响应**：
```json
{
  "success": true,
  "message": "已切换到 DEEPSEEK 模型",
  "currentModel": "deepseek"
}
```

---

#### 6. 获取工具列表

```bash
curl http://localhost:3000/api/tools
```

**预期响应**：
```json
{
  "tools": [
    {
      "name": "summarizeArticle",
      "description": "总结文章的关键信息",
      "parameters": { ... }
    }
  ],
  "count": 3
}
```

---

#### 7. Function Calling 聊天

```bash
curl -X POST http://localhost:3000/api/chat/tools \
  -H "Content-Type: application/json" \
  -d '{
    "message": "查询北京的天气",
    "provider": "glm"
  }'
```

**预期响应**：
```
data: {"type":"tool","tool":"getWeather","params":{"city":"北京"}}
data: {"type":"token","content":"根据查询结果..."}
...
```

---

### 错误情况测试

#### 1. 空消息

```bash
curl -X POST http://localhost:3000/api/chat \
  -H "Content-Type: application/json" \
  -d '{"message":""}'
```

**预期响应**：
```json
{
  "error": "消息内容不能为空",
  "code": "INVALID_MESSAGE"
}
```

---

#### 2. 超长消息

```bash
# 创建超长消息（>10000字符）
LONG_MESSAGE=$(python3 -c "print('a' * 11000)")

curl -X POST http://localhost:3000/api/chat \
  -H "Content-Type: application/json" \
  -d "{\"message\":\"$LONG_MESSAGE\"}"
```

**预期响应**：
```json
{
  "error": "消息长度不能超过 10000 字符",
  "code": "MESSAGE_TOO_LONG"
}
```

---

#### 3. 无效的模型提供商

```bash
curl -X POST http://localhost:3000/api/set-model \
  -H "Content-Type: application/json" \
  -d '{"provider":"invalid"}'
```

**预期响应**：
```json
{
  "error": "无效的模型提供商，必须是 glm 或 deepseek",
  "code": "INVALID_PROVIDER"
}
```

---

## 流式响应测试

### 测试场景

#### 场景1：正常流式响应

**测试步骤**：
1. 发送消息："请详细介绍你自己"
2. 观察流式输出

**检查点**：
- [ ] 第一个 token 在 2 秒内到达
- [ ] token 间隔均匀（无长时间停顿）
- [ ] 最终内容完整

**性能指标**：
- 首次响应时间：< 2秒
- Token 间隔：< 500ms
- 总响应时间：< 30秒

---

#### 场景2：流式中断

**测试步骤**：
1. 发送消息
2. 在流式输出期间关闭浏览器标签
3. 重新打开页面

**检查点**：
- [ ] 服务器日志显示"客户端断开连接"
- [ ] 服务器中止上游 API 调用
- [ ] 无错误或警告

---

#### 场景3：快速连续发送

**测试步骤**：
1. 快速连续发送 3 条消息
2. 观察每条消息的流式输出

**检查点**：
- [ ] 每条消息独立流式输出
- [ ] 无消息混淆
- [ ] 无消息丢失

---

#### 场景4：流式超时

**测试步骤**：
1. 修改 server.js，模拟超时
2. 发送消息
3. 观察错误处理

**检查点**：
- [ ] 显示友好的错误消息
- [ ] 不影响后续对话
- [ ] 控制台有错误日志

---

## Function Calling 测试

### 测试用例

#### 用例1：文章总结工具

**输入**：
```
请总结以下文章的主要内容：

人工智能（Artificial Intelligence，简称AI）是计算机科学的一个分支，
它企图了解智能的实质，并生产出一种新的能以人类智能相似的方式
做出反应的智能机器。该领域的研究包括机器人、语言识别、图像识别、
自然语言处理和专家系统等。
```

**预期行为**：
- [ ] AI 识别需要调用 `summarizeArticle` 工具
- [ ] 工具调用显示："🔧 已使用工具：文章总结"
- [ ] 返回总结内容

**验证点**：
```javascript
// 检查 SSE 事件
data: {"type":"tool","tool":"summarizeArticle","params":{...}}

// 检查最终回复包含总结
```

---

#### 用例2：天气查询工具

**输入**：
```
查询北京今天的天气
```

**预期行为**：
- [ ] AI 识别需要调用 `getWeather` 工具
- [ ] 工具参数包含城市名称："北京"
- [ ] 返回天气信息（温度、湿度等）

**验证点**：
```javascript
// 检查工具调用
data: {"type":"tool","tool":"getWeather","params":{"city":"北京"}}

// 检查回复包含天气信息
```

---

#### 用例3：关键信息提取工具

**输入**：
```
从以下文本中提取关键信息：

项目名称：AI 聊天机器人
版本：v2.2.0
开发者：张三
技术栈：Node.js、Express.js
```

**预期行为**：
- [ ] AI 识别需要调用 `extractKeyInfo` 工具
- [ ] 返回结构化的关键信息

---

#### 用例4：工具调用失败

**模拟**：
- 修改工具实现，抛出错误

**预期行为**：
- [ ] SSE 返回错误事件
- [ ] 显示友好的错误消息
- [ ] AI 继续生成回复（说明工具调用失败）

---

### 工具识别测试

#### 测试消息集

| 消息 | 预期工具 | 说明 |
|------|---------|------|
| "总结这篇文章" | summarizeArticle | 明确意图 |
| "这篇文章讲了什么？" | summarizeArticle | 隐式意图 |
| "提取关键信息" | extractKeyInfo | 明确意图 |
| "查询天气" | getWeather | 明确意图 |
| "今天天气怎么样" | getWeather | 隐式意图 |
| "你好" | 无工具 | 普通对话 |
| "写一首诗" | 无工具 | 创作任务 |

---

## 性能测试

### 响应时间测试

#### 测试方法

```bash
# 使用 time 命令测量
time curl -X POST http://localhost:3000/api/chat \
  -H "Content-Type: application/json" \
  -d '{"message":"你好","provider":"glm"}'
```

**性能指标**：
- ✅ 非流式聊天：< 5秒
- ✅ 流式聊天首次响应：< 2秒
- ✅ 工具调用：< 8秒

---

### 并发测试

#### 测试工具

使用 Apache Bench (ab)：

```bash
# 安装
brew install ab  # macOS
sudo apt-get install apache2-utils  # Ubuntu

# 测试
ab -n 100 -c 10 http://localhost:3000/api/health
```

**参数说明**：
- `-n 100`：总请求数
- `-c 10`：并发数

**性能指标**：
- ✅ 100个请求在 10秒内完成
- ✅ 无失败请求
- ✅ 95% 请求 < 1秒

---

### 内存测试

#### 测试方法

1. 打开浏览器任务管理器（Chrome DevTools > Performance）
2. 记录初始内存占用
3. 进行 50 轮对话
4. 观察内存增长

**性能指标**：
- ✅ 内存增长 < 50MB
- ✅ 无明显内存泄漏
- ✅ localStorage 大小合理

---

## 回归测试

### 测试时机

- ✅ 每次代码合并前
- ✅ 每次发布前
- ✅ 重大功能变更后

### 回归测试清单

#### 核心功能

- [ ] 基本对话功能正常
- [ ] 流式响应正常
- [ ] 多轮对话正常
- [ ] 虚拟形象切换正常
- [ ] AI 模型切换正常
- [ ] 对话历史保存正常

#### Function Calling

- [ ] 文章总结工具正常
- [ ] 关键信息提取工具正常
- [ ] 天气查询工具正常
- [ ] 工具调用标识显示正常

#### 错误处理

- [ ] 空消息被正确拒绝
- [ ] 超长消息被正确拒绝
- [ ] 网络错误有友好提示
- [ ] API 错误有友好提示

---

## 测试报告模板

### 测试报告结构

```markdown
# 测试报告

**测试日期**：2026-01-16
**测试人员**：xxx
**版本**：v2.2.0

## 测试概述
- 测试用例总数：50
- 通过：48
- 失败：2
- 通过率：96%

## 失败用例
1. 用例ID：TC_001
   - 问题描述：...
   - 重现步骤：...
   - 严重程度：P1

## 问题统计
- P0：0个
- P1：1个
- P2：1个

## 建议措施
1. 修复 TC_001 问题
2. 优化性能测试用例 TC_025
```

---

## 测试最佳实践

### 1. 测试前准备

- ✅ 确认环境配置正确
- ✅ 确认 API Keys 有效
- ✅ 确认数据库/缓存已清理
- ✅ 确认浏览器缓存已清理

### 2. 测试过程中

- ✅ 记录所有异常行为
- ✅ 截图保存错误信息
- ✅ 记录复现步骤
- ✅ 标记严重程度

### 3. 测试后

- ✅ 整理测试结果
- ✅ 编写测试报告
- ✅ 跟踪问题修复
- ✅ 验证修复效果

---

## 自动化测试（未来）

### 计划中的自动化

- [ ] 单元测试（Jest）
- [ ] API 集成测试（Supertest）
- [ ] E2E 测试（Playwright）
- [ ] 性能测试（Lighthouse）

### 测试框架选型

| 测试类型 | 推荐工具 | 说明 |
|---------|---------|------|
| 单元测试 | Jest | JavaScript 测试框架 |
| API 测试 | Supertest | HTTP 断言库 |
| E2E 测试 | Playwright | 浏览器自动化 |
| 性能测试 | Lighthouse | Web 性能分析 |

---

## 相关文档

- [API 参考文档](API.md) - API 接口详细说明
- [故障排查指南](TROUBLESHOOTING.md) - 常见问题解决
- [开发指南](CONTRIBUTING.md) - 编码规范

---

**最后更新**：2026-01-16
**维护者**：项目维护团队
